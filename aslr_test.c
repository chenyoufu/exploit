/* Compile: gcc -fno-stack-protector aslr_test.c -ldl -o aslr_test */
/* Enable ASLR: echo 2 > /proc/sys/kernel/randomize_va_space */


#include <stdio.h>
#include <dlfcn.h>

char g_name[64];

void *get_rip()
{
    asm("\n\
        .intel_syntax noprefix\n\
        mov rax, [rbp+8]\n\
        .att_syntax\n\
        ");
}

void *get_libc_system()
{
    void* libc = dlopen("libc.so", RTLD_LAZY);
    return dlsym(libc, "system");
}

int main()
{
    char l_name[64];
    printf("Address of g_name(Global variable): 0x%lx\n", (long)g_name);
    printf("Address of l_name(Local  variable): 0x%lx\n", (long)l_name);
    printf("Address of main  (User code):       0x%lx\n", (long)main);
    printf("Address of system(Share code)       0x%lx\n", (long)get_libc_system());
    printf("Value of rip:                       0x%lx\n", (long)get_rip());
    return 0;

}
